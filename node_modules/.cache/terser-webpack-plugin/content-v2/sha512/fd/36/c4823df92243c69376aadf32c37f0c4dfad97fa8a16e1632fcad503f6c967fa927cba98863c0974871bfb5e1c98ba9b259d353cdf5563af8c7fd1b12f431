{"code":"!function(e){var t={};function n(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var a in e)n.d(s,a,function(t){return e[t]}.bind(null,a));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=3)}([function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.resolve=void 0;const s={acceptTraceContext:!1,apiKey:\"\",dataset:\"\",data:{},redactRequestHeaders:[\"authorization\",\"cookie\",\"referer\"],redactResponseHeaders:[\"set-cookie\"],sampleRates:()=>1,sendTraceContext:!1,serviceName:\"worker\"};t.resolve=function(e){const t=Object.assign({},s,e);return t.redactRequestHeaders=t.redactRequestHeaders.map(e=>e.toLowerCase()),t.redactResponseHeaders=t.redactResponseHeaders.map(e=>e.toLowerCase()),t}},function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.RequestTracer=t.Span=void 0;const s=n(4),a=(e,t)=>{const n={};for(let[s,a]of e.entries())s=s.toLowerCase(),n[s]=t.includes(s)?\"REDACTED\":a;return n};class o{constructor(e,t){this.config=t,this.data={},this.childSpans=[],this.eventMeta={timestamp:Date.now(),name:e.name,trace:e.trace_context,service:e.service}}toHoneycombEvents(){return[Object.assign({},this.data,this.eventMeta),...this.childSpans.map(e=>e.toHoneycombEvents()).flat(1)]}addData(e){Object.assign(this.data,e)}addRequest(e){if(this.request=e,!e)return;const t={headers:e.headers?a(e.headers,this.config.redactRequestHeaders):void 0,method:e.method,redirect:e.redirect,referrer:e.headers.get(\"referer\"),url:e.url};this.addData({request:t})}addResponse(e){if(this.response=e,!e)return;const t={headers:e.headers?a(e.headers,this.config.redactResponseHeaders):void 0,ok:e.ok,redirected:e.redirected,status:e.status,statusText:e.statusText,url:e.url};this.addData({response:t})}log(e){this.data.logs=this.data.logs||[],this.data.logs.push(e)}start(){this.eventMeta.timestamp=Date.now()}finish(){this.eventMeta.duration_ms=Date.now()-this.eventMeta.timestamp}fetch(e,t){const n=new Request(e,t),s=this.startChildSpan(n.url,\"fetch\");if(a=this.config.sendTraceContext,o=n.url,a instanceof RegExp?null!==o.match(a):a){const e=s.eventMeta.trace.getHeaders();n.headers.set(\"traceparent\",e.traceparent),e.tracestate&&n.headers.set(\"tracestate\",e.tracestate)}var a,o;s.addRequest(n);const i=fetch(n);return i.then(e=>{s.addResponse(e),s.finish()}).catch(e=>{s.addData({exception:e}),s.finish()}),i}startChildSpan(e,t){const n=this.eventMeta.trace,s=t?{name:t}:this.eventMeta.service,a=new o({name:e,trace_context:n.getChildContext(),service:s},this.config);return this.childSpans.push(a),a}}t.Span=o;t.RequestTracer=class extends o{constructor(e,t){super({name:\"request\",trace_context:s.TraceContext.newTraceContext(t.acceptTraceContext?e:void 0),service:{name:t.serviceName}},t),this.request=e,this.addRequest(e),this.addData(t.data)}async sendEvents(e){const t=this.getSampleRate(this.data);if(t>=1&&Math.random()<1/t){const n=this.toHoneycombEvents().filter(t=>!e||!e.includes(t.name));await this.sendBatch(n,t)}}finishResponse(e,t){e?this.addResponse(e):t&&(this.addData({exception:!0,responseException:t.toString()}),t.stack&&this.addData({stacktrace:t.stack})),this.finish()}setSampleRate(e){this.sampleRate=e}async sendBatch(e,t){const n=\"https://api.honeycomb.io/1/batch/\"+encodeURIComponent(this.config.dataset),s=e.map(e=>({sampleRate:t,time:new Date(e.timestamp).toISOString(),data:e})),a={method:\"POST\",body:JSON.stringify(s),headers:{Accept:\"application/json\",\"Content-Type\":\"application/json\",\"X-Honeycomb-Team\":this.config.apiKey}},o=new Request(n,a),i=await fetch(o);console.log(\"Honeycomb Response Status: \"+i.status);const r=await i.text();console.log(\"Response: \"+r)}getSampleRate(e){if(void 0!==this.sampleRate)return this.sampleRate;const t=this.config.sampleRates;if(\"function\"==typeof t)return t(e);if(e.response||e.response.status){return t[e.response.status.toString()[0]+\"xx\"]||1}return t.exception}}},function(e,t,n){\"use strict\";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)\"default\"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,\"__esModule\",{value:!0}),a(n(0),t),a(n(1),t),a(n(5),t),a(n(7),t)},function(e,t,n){\"use strict\";n.r(t);var s=n(2);const a={todos:[]},o=(e,t)=>TODOS_APP.put(e,t);async function i(e){const t=\"data-\"+e.headers.get(\"CF-Connecting-IP\");let n;const s=await(i=t,TODOS_APP.get(i));var i;s?n=JSON.parse(s):(await o(t,JSON.stringify(a)),n=a);const r=`\\n<!DOCTYPE html>\\n<html>\\n  <head>\\n    <meta charset=\"UTF-8\">\\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\\n    <title>Todos</title>\\n    <link href=\"https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css\" rel=\"stylesheet\"></link>\\n  </head>\\n\\n  <body class=\"bg-blue-100\">\\n    <div class=\"w-full h-full flex content-center justify-center mt-8\">\\n      <div class=\"bg-white shadow-md rounded px-8 pt-6 py-8 mb-4\">\\n        <h1 class=\"block text-grey-800 text-md font-bold mb-2\">Todos</h1>\\n        <div class=\"flex\">\\n          <input class=\"shadow appearance-none border rounded w-full py-2 px-3 text-grey-800 leading-tight focus:outline-none focus:shadow-outline\" type=\"text\" name=\"name\" placeholder=\"A new todo\"></input>\\n          <button class=\"bg-blue-500 hover:bg-blue-800 text-white font-bold ml-2 py-2 px-4 rounded focus:outline-none focus:shadow-outline\" id=\"create\" type=\"submit\">Create</button>\\n        </div>\\n        <div class=\"mt-4\" id=\"todos\"></div>\\n      </div>\\n    </div>\\n  </body>\\n\\n  <script>\\n    window.todos = ${JSON.stringify(n.todos||[]).replace(/</g,\"\\\\u003c\")}\\n\\n    var updateTodos = function() { \\n      fetch(\"/\", { method: 'PUT', body: JSON.stringify({ todos: window.todos }) })\\n      populateTodos()\\n    }\\n\\n    var completeTodo = function(evt) {\\n      var checkbox = evt.target\\n      var todoElement = checkbox.parentNode\\n      var newTodoSet = [].concat(window.todos)\\n      var todo = newTodoSet.find(t => t.id == todoElement.dataset.todo)\\n      todo.completed = !todo.completed\\n      window.todos = newTodoSet\\n      updateTodos()\\n    }\\n\\n    var populateTodos = function() {\\n      var todoContainer = document.querySelector(\"#todos\")\\n      todoContainer.innerHTML = null\\n\\n      window.todos.forEach(todo => {\\n        var el = document.createElement(\"div\")\\n        el.className = \"border-t py-4\"\\n        el.dataset.todo = todo.id\\n\\n        var name = document.createElement(\"span\")\\n        name.className = todo.completed ? \"line-through\" : \"\"\\n        name.textContent = todo.name\\n\\n        var checkbox = document.createElement(\"input\")\\n        checkbox.className = \"mx-4\"\\n        checkbox.type = \"checkbox\"\\n        checkbox.checked = todo.completed ? 1 : 0\\n        checkbox.addEventListener('click', completeTodo)\\n\\n        el.appendChild(checkbox)\\n        el.appendChild(name)\\n        todoContainer.appendChild(el)\\n      })\\n    }\\n\\n    populateTodos()\\n\\n    var createTodo = function() {\\n      var input = document.querySelector(\"input[name=name]\")\\n      if (input.value.length) {\\n        window.todos = [].concat(todos, { id: window.todos.length + 1, name: input.value, completed: false })\\n        input.value = \"\"\\n        updateTodos()\\n      }\\n    }\\n\\n    document.querySelector(\"#create\").addEventListener('click', createTodo)\\n  <\\/script>\\n</html>\\n`;return e.tracer.log(\"handling request for GET todos\"),e.tracer.addData({todoRequestData:n.todos}),new Response(r,{headers:{\"Content-Type\":\"text/html\"}})}async function r(e){return\"PUT\"===e.method?async function(e){const t=await e.text(),n=\"data-\"+e.headers.get(\"CF-Connecting-IP\");try{return JSON.parse(t),await o(n,t),e.tracer.log(\"handling request for PUT todos\"),e.tracer.addData({todoRequestData:t}),new Response(t,{status:200})}catch(e){return new Response(e,{status:500})}}(e):i(e)}const c=Object(s.hc)({apiKey:\"Ja8xUAvzdqpgls7a2GB2uC\",dataset:\"To-do-list\",acceptTraceContext:!0,sendTraceContext:!0},e=>{e.respondWith(r(e.request))});addEventListener(\"fetch\",c)},function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.TraceContext=void 0;const s=[],a=/^[\\dabcdef]{2}-([\\dabcdef]{32})-([\\dabcdef]{16})-(([\\dabcdef]{2}))/;for(let e=0;e<=255;++e){const t=e.toString(16).padStart(2,\"0\");s.push(t)}function o(e){const t=new Uint8Array(e/2);crypto.getRandomValues(t);const n=new Array(t.length);for(let e=0;e<t.length;++e)n[e]=s[t[e]];return n.join(\"\").toLowerCase()}class i{constructor(e){this.version=0,this.sampled=!0,this.span_id=o(16),e?(this.trace_id=e.trace_id,this.parent_id=e.parent_id,void 0!==e.sampled&&(this.sampled=e.sampled)):this.trace_id=o(32)}static newTraceContext(e){if(e){const t=e.headers.get(\"traceparent\");if(t){const e=function(e){const t=a.exec(e.trim());if(t)return{trace_id:t[1],parent_id:t[2],sampled:\"01\"===t[3]}}(t);return new i(e)}}return new i}getChildContext(){return new i({trace_id:this.trace_id,parent_id:this.span_id,sampled:this.sampled})}getHeaders(){return{traceparent:`00-${this.trace_id}-${this.span_id}-${this.sampled?\"01\":\"00\"}`}}}t.TraceContext=i},function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.hc=t.wrapEventListener=void 0;const s=n(0),a=n(6),o=n(1);class i{constructor(e,t,n){this.event=e,this.listener=t,this.waitUntilUsed=!1,this.config=n,this.tracer=new o.RequestTracer(e.request,this.config),this.waitUntilSpan=this.tracer.startChildSpan(\"waitUntil\",\"worker\"),this.settler=new a.PromiseSettledCoordinator(()=>{this.waitUntilSpan.finish(),this.sendEvents()}),this.setupWaitUntil(),this.setUpRespondWith()}async sendEvents(){const e=this.waitUntilUsed?[]:[\"waitUntil\"];await this.tracer.sendEvents(e),this.waitUntilResolve()}startWaitUntil(){this.waitUntilUsed=!0,this.waitUntilSpan.start()}finishWaitUntil(e){e&&(this.tracer.addData({exception:!0,waitUtilException:e.toString()}),this.waitUntilSpan.addData({exception:e}),e.stack&&this.waitUntilSpan.addData({stacktrace:e.stack}))}setupWaitUntil(){const e=new Promise(e=>{this.waitUntilResolve=e});this.event.waitUntil(e),this.proxyWaitUntil()}proxyWaitUntil(){const e=this;this.event.waitUntil=new Proxy(this.event.waitUntil,{apply:function(t,n,s){e.startWaitUntil();const a=Promise.resolve(s[0]);e.settler.addPromise(a),a.then(()=>{e.finishWaitUntil()}).catch(t=>{e.finishWaitUntil(t)})}})}setUpRespondWith(){this.proxyRespondWith();try{this.event.request.tracer=this.tracer,this.event.waitUntilTracer=this.waitUntilSpan,this.listener(this.event)}catch(e){this.tracer.finishResponse(void 0,e)}}proxyRespondWith(){const e=this;this.event.respondWith=new Proxy(this.event.respondWith,{apply:function(t,n,s){const a=Promise.resolve(s[0]);Reflect.apply(t,n,s);const o=new Promise((t,n)=>{a.then(n=>{setTimeout(()=>{e.tracer.finishResponse(n),t(n)},1)}).catch(t=>{setTimeout(()=>{e.tracer.finishResponse(void 0,t),n(t)},1)})});e.settler.addPromise(o)}})}}function r(e,t){const n=s.resolve(e);return new Proxy(t,{apply:function(e,s,a){const o=a[0];new i(o,t,n)}})}t.wrapEventListener=r;const c=r;t.hc=c},function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.PromiseSettledCoordinator=void 0;t.PromiseSettledCoordinator=class{constructor(e){this.finished=e,this.promises=[],this.allSettled=!1}addPromise(e){if(this.allSettled)throw Error(\"All promises have already been settled\");this.promises.push(e);const t=this.promises.length;Promise.allSettled(this.promises).then(e=>{t===this.promises.length&&(this.allSettled=!0,this.finished(e))})}}},function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0}),t.wrapDurableObject=t.wrapModule=void 0;const s=n(0),a=n(1);async function o(e,t){const n=await e.json();if(await async function(e){const t=\"https://fake-trace-cache.com/\"+e,n=!!await caches.default.match(t);return n&&caches.default.delete(t),n}(n.trace.trace_id)){const e=\"https://api.honeycomb.io/1/events/\"+encodeURIComponent(t.dataset),s={method:\"POST\",body:JSON.stringify(n),headers:{Accept:\"application/json\",\"Content-Type\":\"application/json\",\"X-Honeycomb-Team\":t.apiKey,\"X-Honeycomb-Event-Time\":n.timestamp||n.Timestamp}};return fetch(e,s)}return new Response(\"No trace found with ID: \"+n.trace.trace_id)}function i(e,t,n){return new Proxy(e,{apply:(e,s,a)=>{const o=Reflect.apply(e,s,a);return o.fetch=function(e,t,n){return new Proxy(n.fetch,{apply:(n,s,a)=>{const o=a[0],i=a[1],r=new Request(o,i),c=t.startChildSpan(r.url,e),d=c.eventMeta.trace.getHeaders();r.headers.set(\"traceparent\",d.traceparent),d.tracestate&&r.headers.set(\"tracestate\",d.tracestate),c.addRequest(r);const l=Reflect.apply(n,s,[r]);return l.then(e=>{c.addResponse(e),c.finish()}).catch(e=>{c.addData({exception:e}),c.finish()}),l}})}(n,t,o),o}})}function r(e,t){return new Proxy(e,{get:(e,n,s)=>{const a=Reflect.get(e,n,s);return a&&a.idFromName?function(e,t,n){return new Proxy(e,{get:(s,a,o)=>{const r=Reflect.get(s,a,o);return\"get\"===a?i(r,t,n).bind(e):r?r.bind(e):void 0}})}(a,t,n.toString()):a}})}function c(e,t){return{fetch:new Proxy(t.fetch,{apply:(t,n,s)=>{const i=s[0];if(\"/_send_honeycomb_event\"===new URL(i.url).pathname)return o(i,e);const c=new a.RequestTracer(i,e);var d;c.eventMeta.trace.parent_id&&(d=c.eventMeta.trace.trace_id,caches.default.put(\"https://fake-trace-cache.com/\"+d,new Response(\"Ok\",{headers:{\"cache-control\":\"max-age=90\"}}))),i.tracer=c;const l=s[1];s[1]=r(l,c),e.apiKey=l.HONEYCOMB_API_KEY||e.apiKey,e.dataset=l.HONEYCOMB_DATASET||e.dataset;const h=s[2];try{const e=Reflect.apply(t,n,s);return e instanceof Response?(c.finishResponse(e),h.waitUntil(c.sendEvents()),Promise.resolve(e)):(e.then(e=>(c.finishResponse(e),h.waitUntil(c.sendEvents()),e)),e.catch(e=>{throw c.finishResponse(void 0,e),h.waitUntil(c.sendEvents()),e}),e)}catch(e){throw c.finishResponse(void 0,e),h.waitUntil(c.sendEvents()),e}}})}}t.wrapModule=function(e,t){return c(s.resolve(e),t)},t.wrapDurableObject=function(e,t){const n=s.resolve(e);return n.acceptTraceContext=!0,new Proxy(t,{construct:(e,s)=>{const o=new e(...s);return o.fetch=function(e,t,n){return new Proxy(t,{apply:(t,s,o)=>{const i=o[0],r=new a.RequestTracer(i,e);r.eventMeta.service.name=n,r.eventMeta.name=new URL(i.url).pathname,i.tracer=r;try{const e=Reflect.apply(t,s,o);return e instanceof Response?(r.finishResponse(e),r.sendEvents(),Promise.resolve(e)):(e.then(e=>(r.finishResponse(e),r.sendEvents(),e)),e.catch(e=>{throw r.finishResponse(void 0,e),r.sendEvents(),e}),e)}catch(e){throw r.finishResponse(void 0,e),r.sendEvents(),e}}})}(n,o.fetch,t.name),o}})}}]);","extractedComments":[]}